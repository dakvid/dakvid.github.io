<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
  <meta name="generator" content="radix" />

  <style type="text/css">
  /* Hide doc at startup (prevent jankiness while JS renders/transforms) */
  body {
    visibility: hidden;
  }
  </style>

 <!--radix_placeholder_import_source-->
 <!--/radix_placeholder_import_source-->

  <!--radix_placeholder_meta_tags-->
<title>David's AdVentures In Data: Earthquake Excuses</title>

<meta property="description" itemprop="description" content="Some visualisation experiments using earthquake data. Facet zooming in ggplot and maps with Plotly. (Why didn&#39;t I make these separate posts?)"/>

<link rel="canonical" href="https://david.frigge.nz/posts/2016-12-earthquake-excuses/"/>
<link rel="license" href="https://creativecommons.org/licenses/by/4.0/"/>

<!--  https://schema.org/Article -->
<meta property="article:published" itemprop="datePublished" content="2016-12-28"/>
<meta property="article:created" itemprop="dateCreated" content="2016-12-28"/>
<meta name="article:author" content="David Friggens"/>

<!--  https://developers.facebook.com/docs/sharing/webmasters#markup -->
<meta property="og:title" content="David&#39;s AdVentures In Data: Earthquake Excuses"/>
<meta property="og:type" content="article"/>
<meta property="og:description" content="Some visualisation experiments using earthquake data. Facet zooming in ggplot and maps with Plotly. (Why didn&#39;t I make these separate posts?)"/>
<meta property="og:url" content="https://david.frigge.nz/posts/2016-12-earthquake-excuses/"/>
<meta property="og:image" content="https://david.frigge.nz/posts/2016-12-earthquake-excuses/images/eqnz_depth_comparison.png"/>
<meta property="og:image:width" content="800"/>
<meta property="og:image:height" content="600"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:site_name" content="David&#39;s AdVentures In Data"/>

<!--  https://dev.twitter.com/cards/types/summary -->
<meta property="twitter:card" content="summary_large_image"/>
<meta property="twitter:title" content="David&#39;s AdVentures In Data: Earthquake Excuses"/>
<meta property="twitter:description" content="Some visualisation experiments using earthquake data. Facet zooming in ggplot and maps with Plotly. (Why didn&#39;t I make these separate posts?)"/>
<meta property="twitter:url" content="https://david.frigge.nz/posts/2016-12-earthquake-excuses/"/>
<meta property="twitter:image" content="https://david.frigge.nz/posts/2016-12-earthquake-excuses/images/eqnz_depth_comparison.png"/>
<meta property="twitter:image:width" content="800"/>
<meta property="twitter:image:height" content="600"/>
<meta property="twitter:site" content="@dakvid"/>

<!--/radix_placeholder_meta_tags-->
  <!--radix_placeholder_rmarkdown_metadata-->

<script type="text/json" id="radix-rmarkdown-metadata">
{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["creative_commons","title","description","author","date","preview","categories","output","canonical_url"]}},"value":[{"type":"character","attributes":{},"value":["CC BY"]},{"type":"character","attributes":{},"value":["Earthquake Excuses"]},{"type":"character","attributes":{},"value":["Some visualisation experiments using earthquake data. Facet zooming in ggplot and maps with Plotly. (Why didn't I make these separate posts?)"]},{"type":"list","attributes":{},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name"]}},"value":[{"type":"character","attributes":{},"value":["David Friggens"]}]}]},{"type":"character","attributes":{},"value":["2016-12-28"]},{"type":"character","attributes":{},"value":["images/eqnz_depth_comparison.png"]},{"type":"character","attributes":{},"value":["all","R","earthquakes","New Zealand","rpkg ggplot2","rpkg ggforce","density plots","rpkg plotly","maps"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["radix::radix_article"]}},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["self_contained","toc"]}},"value":[{"type":"logical","attributes":{},"value":[false]},{"type":"logical","attributes":{},"value":[true]}]}]},{"type":"character","attributes":{},"value":["https://david.frigge.nz/posts/2016-12-earthquake-excuses/"]}]}
</script>
<!--/radix_placeholder_rmarkdown_metadata-->
  
  <script type="text/json" id="radix-resource-manifest">
  {"type":"character","attributes":{},"value":["2016-12-earthquake-excuses_files/bowser-1.9.3/bowser.min.js","2016-12-earthquake-excuses_files/crosstalk-1.0.0/css/crosstalk.css","2016-12-earthquake-excuses_files/crosstalk-1.0.0/js/crosstalk.js","2016-12-earthquake-excuses_files/crosstalk-1.0.0/js/crosstalk.js.map","2016-12-earthquake-excuses_files/crosstalk-1.0.0/js/crosstalk.min.js","2016-12-earthquake-excuses_files/crosstalk-1.0.0/js/crosstalk.min.js.map","2016-12-earthquake-excuses_files/distill-2.2.21/template.v2.js","2016-12-earthquake-excuses_files/htmlwidgets-1.3/htmlwidgets.js","2016-12-earthquake-excuses_files/jquery-1.11.3/jquery-AUTHORS.txt","2016-12-earthquake-excuses_files/jquery-1.11.3/jquery.js","2016-12-earthquake-excuses_files/jquery-1.11.3/jquery.min.js","2016-12-earthquake-excuses_files/jquery-1.11.3/jquery.min.map","2016-12-earthquake-excuses_files/plotly-binding-4.8.0/plotly.js","2016-12-earthquake-excuses_files/plotly-htmlwidgets-css-1.39.2/plotly-htmlwidgets.css","2016-12-earthquake-excuses_files/plotly-main-1.39.2/plotly-latest.min.js","2016-12-earthquake-excuses_files/typedarray-0.1/typedarray.min.js","2016-12-earthquake-excuses_files/webcomponents-2.0.0/webcomponents.js","data/big_nz_quakes.csv","data/earthquakes-2009-07-15.csv","data/earthquakes-2010-09-04.csv","data/earthquakes-2011-02-22.csv","data/earthquakes-2016-11-14.csv","data/nz_urban_areas.tsv","images/eqnz_depth_comparison.png"]}
  </script>
  <!--radix_placeholder_navigation_in_header-->

<script type="application/javascript">

  window.headroom_prevent_pin = false;

  window.document.addEventListener("DOMContentLoaded", function (event) {

    // initialize headroom for banner
    var header = $('header').get(0);
    var headerHeight = header.offsetHeight;
    var headroom = new Headroom(header, {
      onPin : function() {
        if (window.headroom_prevent_pin) {
          window.headroom_prevent_pin = false;
          headroom.unpin();
        }
      }
    });
    headroom.init();
    if(window.location.hash)
      headroom.unpin();
    $(header).addClass('headroom--transition');

    // offset scroll location for banner on hash change
    // (see: https://github.com/WickyNilliams/headroom.js/issues/38)
    window.addEventListener("hashchange", function(event) {
      window.scrollTo(0, window.pageYOffset - (headerHeight + 25));
    });

    // responsive menu
    $('.radix-site-header').each(function(i, val) {
      var topnav = $(this);
      var toggle = topnav.find('.nav-toggle');
      toggle.on('click', function() {
        topnav.toggleClass('responsive');
      });
    });

    // nav dropdowns
    $('.nav-dropbtn').click(function(e) {
      $(this).next('.nav-dropdown-content').toggleClass('nav-dropdown-active');
      $(this).parent().siblings('.nav-dropdown')
         .children('.nav-dropdown-content').removeClass('nav-dropdown-active');
    });
    $("body").click(function(e){
      $('.nav-dropdown-content').removeClass('nav-dropdown-active');
    });
    $(".nav-dropdown").click(function(e){
      e.stopPropagation();
    });
  });
</script>

<style type="text/css">

/* Theme (user-documented overrideables for nav appearance) */

.radix-site-nav {
  color: rgba(255, 255, 255, 0.8);
  background-color: #455a64;
  font-size: 15px;
  font-weight: 300;
}

.radix-site-nav a {
  color: inherit;
  text-decoration: none;
}

.radix-site-nav a:hover {
  color: white;
}

@media print {
  .radix-site-nav {
    display: none;
  }
}

.radix-site-header {

}

.radix-site-footer {

}


/* Site Header */

.radix-site-header {
  width: 100%;
  box-sizing: border-box;
  z-index: 3;
}

.radix-site-header .nav-left {
  display: inline-block;
  margin-left: 8px;
}

@media screen and (max-width: 768px) {
  .radix-site-header .nav-left {
    margin-left: 0;
  }
}


.radix-site-header .nav-right {
  float: right;
  margin-right: 8px;
}

.radix-site-header a,
.radix-site-header .title {
  display: inline-block;
  text-align: center;
  padding: 14px 10px 14px 10px;
}

.radix-site-header .title {
  font-size: 18px;
}

.radix-site-header .logo {
  padding: 0;
}

.radix-site-header .logo img {
  display: none;
  max-height: 20px;
  width: auto;
  margin-bottom: -4px;
}

.radix-site-header .nav-image img {
  max-height: 18px;
  width: auto;
  display: inline-block;
  margin-bottom: -3px;
}



@media screen and (min-width: 1000px) {
  .radix-site-header .logo img {
    display: inline-block;
  }
  .radix-site-header .nav-left {
    margin-left: 20px;
  }
  .radix-site-header .nav-right {
    margin-right: 20px;
  }
  .radix-site-header .title {
    padding-left: 12px;
  }
}


.radix-site-header .nav-toggle {
  display: none;
}

.nav-dropdown {
  display: inline-block;
  position: relative;
}

.nav-dropdown .nav-dropbtn {
  border: none;
  outline: none;
  color: rgba(255, 255, 255, 0.8);
  padding: 16px 10px;
  background-color: transparent;
  font-family: inherit;
  font-size: inherit;
  font-weight: inherit;
  margin: 0;
  margin-top: 1px;
  z-index: 2;
}

.nav-dropdown-content {
  display: none;
  position: absolute;
  background-color: white;
  min-width: 200px;
  border: 1px solid rgba(0,0,0,0.15);
  border-radius: 4px;
  box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.1);
  z-index: 1;
  margin-top: 2px;
  white-space: nowrap;
  padding-top: 4px;
  padding-bottom: 4px;
}

.nav-dropdown-content hr {
  margin-top: 4px;
  margin-bottom: 4px;
  border: none;
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.nav-dropdown-active {
  display: block;
}

.nav-dropdown-content a, .nav-dropdown-content .nav-dropdown-header {
  color: black;
  padding: 6px 24px;
  text-decoration: none;
  display: block;
  text-align: left;
}

.nav-dropdown-content .nav-dropdown-header {
  display: block;
  padding: 5px 24px;
  padding-bottom: 0;
  text-transform: uppercase;
  font-size: 14px;
  color: #999999;
  white-space: nowrap;
}

.nav-dropdown:hover .nav-dropbtn {
  color: white;
}

.nav-dropdown-content a:hover {
  background-color: #ddd;
  color: black;
}

.nav-right .nav-dropdown-content {
  margin-left: -45%;
  right: 0;
}

@media screen and (max-width: 768px) {
  .radix-site-header a, .radix-site-header .nav-dropdown  {display: none;}
  .radix-site-header a.nav-toggle {
    float: right;
    display: block;
  }
  .radix-site-header .title {
    margin-left: 0;
  }
  .radix-site-header .nav-right {
    margin-right: 0;
  }
  .radix-site-header {
    overflow: hidden;
  }
  .nav-right .nav-dropdown-content {
    margin-left: 0;
  }
}


@media screen and (max-width: 768px) {
  .radix-site-header.responsive {position: relative;}
  .radix-site-header.responsive a.nav-toggle {
    position: absolute;
    right: 0;
    top: 0;
  }
  .radix-site-header.responsive a,
  .radix-site-header.responsive .nav-dropdown {
    display: block;
    text-align: left;
  }
  .radix-site-header.responsive .nav-left,
  .radix-site-header.responsive .nav-right {
    width: 100%;
  }
  .radix-site-header.responsive .nav-dropdown {float: none;}
  .radix-site-header.responsive .nav-dropdown-content {position: relative;}
  .radix-site-header.responsive .nav-dropdown .nav-dropbtn {
    display: block;
    width: 100%;
    text-align: left;
  }
}

/* Site Footer */

.radix-site-footer {
  width: 100%;
  overflow: hidden;
  box-sizing: border-box;
  z-index: 3;
  margin-top: 30px;
  padding-top: 30px;
  padding-bottom: 30px;
  text-align: center;
}

/* Headroom */

d-title {
  padding-top: 6rem;
}

@media print {
  d-title {
    padding-top: 4rem;
  }
}

.headroom {
  z-index: 1000;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
}

.headroom--transition {
  transition: all .4s ease-in-out;
}

.headroom--unpinned {
  top: -100px;
}

.headroom--pinned {
  top: 0;
}

</style>

<link href="../../site_libs/font-awesome-5.0.13/css/fa-svg-with-js.css" rel="stylesheet"/>
<script src="../../site_libs/font-awesome-5.0.13/js/fontawesome-all.min.js"></script>
<script src="../../site_libs/font-awesome-5.0.13/js/fa-v4-shims.min.js"></script>
<script src="../../site_libs/headroom-0.9.4/headroom.min.js"></script>
<!--/radix_placeholder_navigation_in_header-->
  <!--radix_placeholder_distill-->

<style type="text/css">

body {
  background-color: white;
}

.pandoc-table {
  width: 100%;
}

.pandoc-table>caption {
  margin-bottom: 10px;
}

.pandoc-table th:not([align]) {
  text-align: left;
}

.pagedtable-footer {
  font-size: 15px;
}

.html-widget {
  margin-bottom: 2.0em;
}

.l-screen-inset {
  padding-right: 16px;
}

.l-screen .caption {
  margin-left: 10px;
}

.shaded {
  background: rgb(247, 247, 247);
  padding-top: 20px;
  padding-bottom: 20px;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.shaded .html-widget {
  margin-bottom: 0;
  border: 1px solid rgba(0, 0, 0, 0.1);
}

.shaded .shaded-content {
  background: white;
}

.text-output {
  margin-top: 0;
  line-height: 1.5em;
}

.hidden {
  display: none !important;
}

d-article {
  padding-bottom: 30px;
}

d-appendix {
  padding-top: 30px;
}

d-article>p>img {
  width: 100%;
}

d-article iframe {
  border: 1px solid rgba(0, 0, 0, 0.1);
  margin-bottom: 2.0em;
  width: 100%;
}

figure img.external {
  background: white;
  border: 1px solid rgba(0, 0, 0, 0.1);
  box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
  padding: 18px;
  box-sizing: border-box;
}

/* CSS for table of contents */

.d-toc {
  color: rgba(0,0,0,0.8);
  font-size: 0.8em;
  line-height: 1em;
}

.d-toc-header {
  font-size: 0.6rem;
  font-weight: 400;
  color: rgba(0, 0, 0, 0.5);
  text-transform: uppercase;
  margin-top: 0;
  margin-bottom: 1.3em;
}

.d-toc a {
  border-bottom: none;
}

.d-toc ul {
  padding-left: 0;
}

.d-toc li>ul {
  padding-top: 0.8em;
  padding-left: 16px;
  margin-bottom: 0.6em;
}

.d-toc ul,
.d-toc li {
  list-style-type: none;
}

.d-toc li {
  margin-bottom: 0.9em;
}

.d-toc-separator {
  margin-top: 20px;
  margin-bottom: 2em;
}

.d-article-with-toc {
  border-top: none;
  padding-top: 0;
}



/* Tweak code blocks (note that this CSS is repeated above in an injection
   into the d-code shadow dom) */

pre.d-code code.d-code {
  padding-left: 10px;
  font-size: 12px;
  border-left: 2px solid rgba(0,0,0,0.1);
}

pre.text-output {

  font-size: 12px;
  color: black;
  background: none;
  font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.5;

  -moz-tab-size: 4;
  -o-tab-size: 4;
  tab-size: 4;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

@media(min-width: 768px) {
pre.d-code code.d-code  {
    padding-left: 18px;
    font-size: 14px;
}
pre.text-output {
  font-size: 14px;
}
}

/* Figure */

.figure {
  position: relative;
  margin-bottom: 2.5em;
  margin-top: 1.5em;
}

.figure img {
  width: 100%;
}

.figure .caption {
  color: rgba(0, 0, 0, 0.6);
  font-size: 12px;
  line-height: 1.5em;
}

.figure img.external {
  background: white;
  border: 1px solid rgba(0, 0, 0, 0.1);
  box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
  padding: 18px;
  box-sizing: border-box;
}

.figure .caption a {
  color: rgba(0, 0, 0, 0.6);
}

.figure .caption b,
.figure .caption strong, {
  font-weight: 600;
  color: rgba(0, 0, 0, 1.0);
}



/* Tweak 1000px media break to show more text */

@media(min-width: 1000px) {
  .base-grid,
  distill-header,
  d-title,
  d-abstract,
  d-article,
  d-appendix,
  distill-appendix,
  d-byline,
  d-footnote-list,
  d-citation-list,
  distill-footer {
    grid-template-columns: [screen-start] 1fr [page-start kicker-start] 80px [middle-start] 50px [text-start kicker-end] 65px 65px 65px 65px 65px 65px 65px 65px [text-end gutter-start] 65px [middle-end] 65px [page-end gutter-end] 1fr [screen-end];
    grid-column-gap: 16px;
  }

  .grid {
    grid-column-gap: 16px;
  }

  d-article {
    font-size: 1.06rem;
    line-height: 1.7em;
  }
  figure .caption, .figure .caption, figure figcaption {
    font-size: 13px;
  }
}

@media(min-width: 1180px) {
  .base-grid,
  distill-header,
  d-title,
  d-abstract,
  d-article,
  d-appendix,
  distill-appendix,
  d-byline,
  d-footnote-list,
  d-citation-list,
  distill-footer {
    grid-template-columns: [screen-start] 1fr [page-start kicker-start] 60px [middle-start] 60px [text-start kicker-end] 60px 60px 60px 60px 60px 60px 60px 60px [text-end gutter-start] 60px [middle-end] 60px [page-end gutter-end] 1fr [screen-end];
    grid-column-gap: 32px;
  }

  .grid {
    grid-column-gap: 32px;
  }
}


/* Get the citation styles for the appendix (not auto-injected on render since
   we do our own rendering of the citation appendix) */

d-appendix .citation-appendix,
.d-appendix .citation-appendix {
  font-size: 11px;
  line-height: 15px;
  border-left: 1px solid rgba(0, 0, 0, 0.1);
  padding-left: 18px;
  border: 1px solid rgba(0,0,0,0.1);
  background: rgba(0, 0, 0, 0.02);
  padding: 10px 18px;
  border-radius: 3px;
  color: rgba(150, 150, 150, 1);
  overflow: hidden;
  margin-top: -12px;
  white-space: pre-wrap;
  word-wrap: break-word;
}


/* Social footer */

.social_footer {
  margin-top: 30px;
  margin-bottom: 0;
  color: rgba(0,0,0,0.67);
}

.disqus-comments {
  margin-right: 30px;
}

.disqus-comment-count {
  border-bottom: 1px solid rgba(0, 0, 0, 0.4);
  cursor: pointer;
}

#disqus_thread {
  margin-top: 30px;
}

.article-sharing a {
  border-bottom: none;
  margin-right: 8px;
}

.article-sharing a:hover {
  border-bottom: none;
}

.sidebar-section.subscribe {
  font-size: 12px;
  line-height: 1.6em;
}

.subscribe p {
  margin-bottom: 0.5em;
}


.article-footer .subscribe {
  font-size: 15px;
  margin-top: 45px;
}


/* Improve display for browsers without grid (IE/Edge <= 15) */

.downlevel {
  line-height: 1.6em;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
  margin: 0;
}

.downlevel .d-title {
  padding-top: 6rem;
  padding-bottom: 1.5rem;
}

.downlevel .d-title h1 {
  font-size: 50px;
  font-weight: 700;
  line-height: 1.1em;
  margin: 0 0 0.5rem;
}

.downlevel .d-title p {
  font-weight: 300;
  font-size: 1.2rem;
  line-height: 1.55em;
  margin-top: 0;
}

.downlevel .d-byline {
  padding-top: 0.8em;
  padding-bottom: 0.8em;
  font-size: 0.8rem;
  line-height: 1.8em;
}

.downlevel .section-separator {
  border: none;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
}

.downlevel .d-article {
  font-size: 1.06rem;
  line-height: 1.7em;
  padding-top: 1rem;
  padding-bottom: 2rem;
}


.downlevel .d-appendix {
  padding-left: 0;
  padding-right: 0;
  max-width: none;
  font-size: 0.8em;
  line-height: 1.7em;
  margin-bottom: 0;
  color: rgba(0,0,0,0.5);
  padding-top: 40px;
  padding-bottom: 48px;
}

.downlevel .footnotes ol {
  padding-left: 13px;
}

.downlevel .base-grid,
.downlevel .distill-header,
.downlevel .d-title,
.downlevel .d-abstract,
.downlevel .d-article,
.downlevel .d-appendix,
.downlevel .distill-appendix,
.downlevel .d-byline,
.downlevel .d-footnote-list,
.downlevel .d-citation-list,
.downlevel .distill-footer,
.downlevel .appendix-bottom,
.downlevel .posts-container {
  padding-left: 40px;
  padding-right: 40px;
}

@media(min-width: 768px) {
  .downlevel .base-grid,
  .downlevel .distill-header,
  .downlevel .d-title,
  .downlevel .d-abstract,
  .downlevel .d-article,
  .downlevel .d-appendix,
  .downlevel .distill-appendix,
  .downlevel .d-byline,
  .downlevel .d-footnote-list,
  .downlevel .d-citation-list,
  .downlevel .distill-footer,
  .downlevel .appendix-bottom,
  .downlevel .posts-container {
  padding-left: 150px;
  padding-right: 150px;
  max-width: 900px;
}
}

.downlevel pre code {
  display: block;
  border-left: 2px solid rgba(0, 0, 0, .1);
  padding: 0 0 0 20px;
  font-size: 14px;
}

.downlevel code, .downlevel pre {
  color: black;
  background: none;
  font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.5;

  -moz-tab-size: 4;
  -o-tab-size: 4;
  tab-size: 4;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

</style>

<script type="application/javascript">

function is_downlevel_browser() {
  if (bowser.isUnsupportedBrowser({ msie: "12", msedge: "16"},
                                 window.navigator.userAgent)) {
    return true;
  } else {
    return window.load_distill_framework === undefined;
  }
}

// show body when load is complete
function on_load_complete() {

  // set body to visible
  document.body.style.visibility = 'visible';

  // force redraw for leaflet widgets
  if (window.HTMLWidgets) {
    var maps = window.HTMLWidgets.findAll(".leaflet");
    $.each(maps, function(i, el) {
      var map = this.getMap();
      map.invalidateSize();
      map.eachLayer(function(layer) {
        if (layer instanceof L.TileLayer)
          layer.redraw();
      });
    });
  }

  // trigger 'shown' so htmlwidgets resize
  $('d-article').trigger('shown');
}

function init_distill() {

  init_common();

  // create front matter
  var front_matter = $('<d-front-matter></d-front-matter>');
  $('#distill-front-matter').wrap(front_matter);

  // create d-title
  $('.d-title').changeElementType('d-title');

  // create d-byline
  var byline = $('<d-byline></d-byline>');
  $('.d-byline').replaceWith(byline);

  // create d-article
  var article = $('<d-article></d-article>');
  $('.d-article').wrap(article).children().unwrap();

  // move posts container into article
  $('.posts-container').appendTo($('d-article'));

  // create d-appendix
  $('.d-appendix').changeElementType('d-appendix');

  // create d-bibliography
  var bibliography = $('<d-bibliography></d-bibliography>');
  $('#distill-bibliography').wrap(bibliography);

  // flag indicating that we have appendix items
  var appendix = $('.appendix-bottom').children('h3').length > 0;

  // replace citations with <d-cite>
  $('.citation').each(function(i, val) {
    appendix = true;
    var cites = $(this).attr('data-cites').split(" ");
    var dt_cite = $('<d-cite></d-cite>');
    dt_cite.attr('key', cites.join());
    $(this).replaceWith(dt_cite);
  });
  // remove refs
  $('#refs').remove();

  // replace footnotes with <d-footnote>
  $('.footnote-ref').each(function(i, val) {
    appendix = true;
    var href = $(this).attr('href');
    var id = href.replace('#', '');
    var fn = $('#' + id);
    var fn_p = $('#' + id + '>p');
    fn_p.find('.footnote-back').remove();
    var text = fn_p.html();
    var dtfn = $('<d-footnote></d-footnote>');
    dtfn.html(text);
    $(this).replaceWith(dtfn);
  });
  // remove footnotes
  $('.footnotes').remove();

  $('h1.appendix, h2.appendix').each(function(i, val) {
    $(this).changeElementType('h3');
  });
  $('h3.appendix').each(function(i, val) {
    var id = $(this).attr('id');
    $('.d-toc a[href="#' + id + '"]').parent().remove();
    appendix = true;
    $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('d-appendix'));
  });

  // show d-appendix if we have appendix content
  $("d-appendix").css('display', appendix ? 'grid' : 'none');

  // replace code blocks with d-code
  $('pre>code').each(function(i, val) {
    var code = $(this);
    var pre = code.parent();
    var clz = "";
    var language = pre.attr('class');
    if (language) {
      // map unknown languages to "clike" (without this they just dissapear)
      if ($.inArray(language, ["bash", "clike", "css", "go", "html",
                               "javascript", "js", "julia", "lua", "markdown",
                               "markup", "mathml", "python", "svg", "xml"]) == -1)
        language = "clike";
      language = ' language="' + language + '"';
      var dt_code = $('<d-code block' + language + clz + '></d-code>');
      dt_code.text(code.text());
      pre.replaceWith(dt_code);
    } else {
      code.addClass('text-output').unwrap().changeElementType('pre');
    }
  });

  // localize layout chunks to just output
  $('.layout-chunk').each(function(i, val) {

    // capture layout
    var layout = $(this).attr('data-layout');

    // apply layout to markdown level block elements
    var elements = $(this).children().not('d-code, pre.text-output, script');
    elements.each(function(i, el) {
      var layout_div = $('<div class="' + layout + '"></div>');
      if (layout_div.hasClass('shaded')) {
        var shaded_content = $('<div class="shaded-content"></div>');
        $(this).wrap(shaded_content);
        $(this).parent().wrap(layout_div);
      } else {
        $(this).wrap(layout_div);
      }
    });


    // unwrap the layout-chunk div
    $(this).children().unwrap();
  });

  // load distill framework
  load_distill_framework();

  // wait for window.distillRunlevel == 4 to do post processing
  function distill_post_process() {

    if (!window.distillRunlevel || window.distillRunlevel < 4)
      return;

    // hide author/affiliations entirely if we have no authors
    var front_matter = JSON.parse($("#distill-front-matter").html());
    var have_authors = front_matter.authors && front_matter.authors.length > 0;
    if (!have_authors)
      $('d-byline').addClass('hidden');

    // table of contents
    if (have_authors) // adjust border if we are in authors
      $('.d-toc').parent().addClass('d-article-with-toc');

    // strip links that point to #
    $('.authors-affiliations').find('a[href="#"]').removeAttr('href');

    // hide elements of author/affiliations grid that have no value
    function hide_byline_column(caption) {
      $('d-byline').find('h3:contains("' + caption + '")').parent().css('visibility', 'hidden');
    }

    // affiliations
    var have_affiliations = false;
    for (var i = 0; i<front_matter.authors.length; ++i) {
      var author = front_matter.authors[i];
      if (author.affiliation !== "&nbsp;") {
        have_affiliations = true;
        break;
      }
    }
    if (!have_affiliations)
      $('d-byline').find('h3:contains("Affiliations")').css('visibility', 'hidden');

    // published date
    if (!front_matter.publishedDate)
      hide_byline_column("Published");

    // document object identifier
    var doi = $('d-byline').find('h3:contains("DOI")');
    var doi_p = doi.next().empty();
    if (!front_matter.doi) {
      // if we have a citation and valid citationText then link to that
      if ($('#citation').length > 0 && front_matter.citationText) {
        doi.html('Citation');
        $('<a href="#citation"></a>')
          .text(front_matter.citationText)
          .appendTo(doi_p);
      } else {
        hide_byline_column("DOI");
      }
    } else {
      $('<a></a>')
         .attr('href', "https://doi.org/" + front_matter.doi)
         .html(front_matter.doi)
         .appendTo(doi_p);
    }

     // change plural form of authors/affiliations
    if (front_matter.authors.length === 1) {
      var grid = $('.authors-affiliations');
      grid.children('h3:contains("Authors")').text('Author');
      grid.children('h3:contains("Affiliations")').text('Affiliation');
    }

    // inject pre code styles (can't do this with a global stylesheet b/c a shadow root is used)
    $('d-code').each(function(i, val) {
      var style = document.createElement('style');
      style.innerHTML = 'pre code { padding-left: 10px; font-size: 12px; border-left: 2px solid rgba(0,0,0,0.1); } ' +
                        '@media(min-width: 768px) { pre code { padding-left: 18px; font-size: 14px; } }';
      if (this.shadowRoot)
        this.shadowRoot.appendChild(style);
    });

    // move appendix-bottom entries to the bottom
    $('.appendix-bottom').appendTo('d-appendix').children().unwrap();
    $('.appendix-bottom').remove();

    // clear polling timer
    clearInterval(tid);

    // show body now that everything is ready
    on_load_complete();
  }

  var tid = setInterval(distill_post_process, 50);
  distill_post_process();

}

function init_downlevel() {

  init_common();

   // insert hr after d-title
  $('.d-title').after($('<hr class="section-separator"/>'));

  // check if we have authors
  var front_matter = JSON.parse($("#distill-front-matter").html());
  var have_authors = front_matter.authors && front_matter.authors.length > 0;

  // manage byline/border
  if (!have_authors)
    $('.d-byline').remove();
  $('.d-byline').after($('<hr class="section-separator"/>'));
  $('.d-byline a').remove();

  // remove toc
  $('.d-toc-header').remove();
  $('.d-toc').remove();
  $('.d-toc-separator').remove();

  // move appendix elements
  $('h1.appendix, h2.appendix').each(function(i, val) {
    $(this).changeElementType('h3');
  });
  $('h3.appendix').each(function(i, val) {
    $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('.d-appendix'));
  });


  // inject headers into references and footnotes
  var refs_header = $('<h3></h3>');
  refs_header.text('References');
  $('#refs').prepend(refs_header);

  var footnotes_header = $('<h3></h3');
  footnotes_header.text('Footnotes');
  $('.footnotes').children('hr').first().replaceWith(footnotes_header);

  // move appendix-bottom entries to the bottom
  $('.appendix-bottom').appendTo('.d-appendix').children().unwrap();
  $('.appendix-bottom').remove();

  // remove appendix if it's empty
  if ($('.d-appendix').children().length === 0)
    $('.d-appendix').remove();

  // prepend separator above appendix
  $('.d-appendix').before($('<hr class="section-separator" style="clear: both"/>'));

  // trim code
  $('pre>code').each(function(i, val) {
    $(this).html($.trim($(this).html()));
  });

  // move posts-container right before article
  $('.posts-container').insertBefore($('.d-article'));

  $('body').addClass('downlevel');

  on_load_complete();
}


function init_common() {

  // jquery plugin to change element types
  (function($) {
    $.fn.changeElementType = function(newType) {
      var attrs = {};

      $.each(this[0].attributes, function(idx, attr) {
        attrs[attr.nodeName] = attr.nodeValue;
      });

      this.replaceWith(function() {
        return $("<" + newType + "/>", attrs).append($(this).contents());
      });
    };
  })(jQuery);

  // prevent underline for linked images
  $('a > img').parent().css({'border-bottom' : 'none'});

  // mark non-body figures created by knitr chunks as 100% width
  $('.layout-chunk').each(function(i, val) {
    var figures = $(this).find('img, .html-widget');
    if ($(this).attr('data-layout') !== "l-body") {
      figures.css('width', '100%');
    } else {
      figures.css('max-width', '100%');
      figures.filter("[width]").each(function(i, val) {
        var fig = $(this);
        fig.css('width', fig.attr('width') + 'px');
      });

    }
  });

  // auto-append index.html to post-preview links in file: protocol
  // and in rstudio ide preview
  $('.post-preview').each(function(i, val) {
    if (window.location.protocol === "file:")
      $(this).attr('href', $(this).attr('href') + "index.html");
  });

  // get rid of index.html references in header
  if (window.location.protocol !== "file:") {
    $('.radix-site-header a[href]').each(function(i,val) {
      $(this).attr('href', $(this).attr('href').replace("index.html", "./"));
    });
  }

  // add class to pandoc style tables
  $('tr.header').parent('thead').parent('table').addClass('pandoc-table');
  $('.kable-table').children('table').addClass('pandoc-table');

  // add figcaption style to table captions
  $('caption').parent('table').addClass("figcaption");

  // initialize posts list
  if (window.init_posts_list)
    window.init_posts_list();

  // implmement disqus comment link
  $('.disqus-comment-count').click(function() {
    window.headroom_prevent_pin = true;
    $('#disqus_thread').toggleClass('hidden');
    if (!$('#disqus_thread').hasClass('hidden')) {
      var offset = $(this).offset();
      $(window).resize();
      $('html, body').animate({
        scrollTop: offset.top - 35
      });
    }
  });
}

document.addEventListener('DOMContentLoaded', function() {
  if (is_downlevel_browser())
    init_downlevel();
  else
    window.addEventListener('WebComponentsReady', init_distill);
});

</script>

<!--/radix_placeholder_distill-->
  <script src="../../site_libs/htmlwidgets-1.3/htmlwidgets.js"></script>
  <script src="../../site_libs/plotly-binding-4.8.0/plotly.js"></script>
  <script src="../../site_libs/typedarray-0.1/typedarray.min.js"></script>
  <script src="../../site_libs/jquery-1.11.3/jquery.min.js"></script>
  <link href="../../site_libs/crosstalk-1.0.0/css/crosstalk.css" rel="stylesheet" />
  <script src="../../site_libs/crosstalk-1.0.0/js/crosstalk.min.js"></script>
  <link href="../../site_libs/plotly-htmlwidgets-css-1.39.2/plotly-htmlwidgets.css" rel="stylesheet" />
  <script src="../../site_libs/plotly-main-1.39.2/plotly-latest.min.js"></script>
  <script src="../../site_libs/bowser-1.9.3/bowser.min.js"></script>
  <script src="../../site_libs/webcomponents-2.0.0/webcomponents.js"></script>
  <script src="../../site_libs/distill-2.2.21/template.v2.js"></script>
  <!--radix_placeholder_site_in_header-->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-30013353-2"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-30013353-2');
</script>
<!--/radix_placeholder_site_in_header-->


</head>

<body>

<!--radix_placeholder_front_matter-->

<script id="distill-front-matter" type="text/json">
{"title":"Earthquake Excuses","description":"Some visualisation experiments using earthquake data. Facet zooming in ggplot and maps with Plotly. (Why didn't I make these separate posts?)","authors":[{"author":"David Friggens","authorURL":"#","affiliation":"&nbsp;","affiliationURL":"#"}],"publishedDate":"2016-12-28T00:00:00.000+13:00","citationText":"Friggens, 2016"}
</script>

<!--/radix_placeholder_front_matter-->
<!--radix_placeholder_navigation_before_body-->
<header class="header header--fixed" role="banner">
<nav class="radix-site-nav radix-site-header">
<div class="nav-left">
<a href="../../index.html" class="title">David's AdVentures In Data</a>
</div>
<div class="nav-right">
<a href="../../index.html">Blog</a>
<a href="../../projects.html">Projects</a>
<a href="../../about.html">About</a>
<a href="https://twitter.com/dakvid">
<i class="fa fa-twitter"></i>
</a>
<a href="../../index.xml">
<i class="fa fa-rss"></i>
</a>
<a href="javascript:void(0);" class="nav-toggle">&#9776;</a>
</div>
</nav>
</header>
<!--/radix_placeholder_navigation_before_body-->
<!--radix_placeholder_site_before_body-->
<!--/radix_placeholder_site_before_body-->

<div class="d-title">
<h1>Earthquake Excuses</h1>
<p>Some visualisation experiments using earthquake data. Facet zooming in ggplot and maps with Plotly. (Why didn’t I make these separate posts?)</p>
</div>

<div class="d-byline">
  
  David Friggens
  
<br/>2016-12-28
</div>

<div class="d-article">
<h3 class="d-toc-header">Table of Contents</h3>
<nav class="d-toc" id="TOC">
<ul>
<li><a href="#quake-patterns-differ-or-how-to-zoom-a-facet">Quake patterns differ, or, How to zoom a facet</a><ul>
<li><a href="#code-listing">Code listing</a></li>
</ul></li>
<li><a href="#big-quakes-are-almost-everywhere-or-scatter-plots-on-maps-with-plotly">Big quakes are (almost) everywhere, or, Scatter plots on maps with Plotly</a><ul>
<li><a href="#code-listing-1">Code listing</a></li>
</ul></li>
</ul>
</nav>
<hr class="d-toc-separator"/>
<p>After my <a href="../2016-11-earthquake-depth/">first foray into earthquake data</a> I poked around a bit more but didn’t produce anything hugely revelatory. I thought I’d use the data though as an excuse to try out a couple of new things: zooming facets in <code>ggplot2</code>, and creating maps with Plotly.</p>
<p>If you are interested in more earthquake insights specifically, two of my favourite visualisations on the matter have been:</p>
<ul>
<li>Sarah Habershon’s <a href="http://optimalbi-aws-nz-play-earthquakeblog.s3-website-ap-southeast-2.amazonaws.com/">connected plot and map in d3</a> (see also explanatory posts <a href="http://optimalbi.com/blog/2016/11/25/oh-these-shaky-isles/">one</a> and <a href="http://optimalbi.com/blog/2016/12/02/drop-cover-hold-how-i-made-my-shaky-isles-visualisation/">two</a>), and</li>
<li>Stefan Marks’ <a href="https://www.youtube.com/watch?v=ciIvHP0qkis">3d visualisation of a century of quakes (YouTube)</a>.</li>
</ul>
<h2 id="quake-patterns-differ-or-how-to-zoom-a-facet">Quake patterns differ, or, How to zoom a facet</h2>
<p>It was interesting to look at the <a href="../2016-11-earthquake-depth/">depths of the recent earthquakes</a>, but it did leave me wondering if these were typical. Are NZ quakes typically distributed like this? Were the last canterbury quakes this shallow?</p>
<p>I plotted the distributions of the first 24 hours of quakes following four major events in recent years. It was interesting to see that there was some difference between them. Frustratingly, most of the quakes were relatively shallow, but there were a few very deep ones. Do you leave in all the data to show the full range but make the detail hard to see, or crop the tail to tradeoff against better visibility of the peaks? Enter <code>facet_zoom</code> from the new <a href="https://github.com/thomasp85/ggforce">ggforce</a> package, which allows us to see the whole graph, but also zoom in on the detail of interest.</p>
<p><img src="images/eqnz_depth_comparison.png" /></p>
<h3 id="code-listing">Code listing</h3>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
library(readr)
library(purrr)
library(dplyr)
library(magrittr)
library(forcats)
library(ggplot2)
library(ggthemes)
library(ggforce)

list(
  #&quot;http://quakesearch.geonet.org.nz/csv?bbox=163.60840,-49.18170,182.98828,-32.28713&amp;minmag=2&amp;startdate=2009-07-15T9:00:00&amp;enddate=2009-07-16T9:00:00&quot;,
  &quot;data/earthquakes-2009-07-15.csv&quot;,
  #&quot;http://quakesearch.geonet.org.nz/csv?bbox=163.60840,-49.18170,182.98828,-32.28713&amp;minmag=2&amp;startdate=2010-09-03T16:00:00&amp;enddate=2010-09-04T16:00:00&quot;,
  &quot;data/earthquakes-2010-09-04.csv&quot;,
  #&quot;http://quakesearch.geonet.org.nz/csv?bbox=163.60840,-49.18170,182.98828,-32.28713&amp;minmag=2&amp;startdate=2011-02-21T23:00:00&amp;enddate=2011-02-22T23:00:00&quot;,
  &quot;data/earthquakes-2011-02-22.csv&quot;,
  #&quot;http://quakesearch.geonet.org.nz/csv?bbox=163.60840,-49.18170,182.98828,-32.28713&amp;minmag=2&amp;startdate=2016-11-13T11:00:00&amp;enddate=2016-11-14T11:00:00&quot;
  &quot;data/earthquakes-2016-11-14.csv&quot;
) %&gt;% 
  map(read_csv) %&gt;% 
  map(filter, eventtype == &quot;earthquake&quot; | is.na(eventtype)) %&gt;% 
  map(select, depth) %&gt;% 
  map2_df(
    list(
      &quot;Dusky Sound, 15 Jul 2009, 7.8M&quot;,
      &quot;Darfield, 4 Sep 2010, 7.1M&quot;,
      &quot;Christchurch, 22 Feb 2011, 6.3M&quot;,
      &quot;Kaikoura, 14 Nov 2016, 7.8M&quot;
    ),
    function(df, ch) {
      df %&gt;%
        mutate(Event = ch)
    }
  ) -&gt;
eq_24h

png(&quot;images/eqnz_depth_comparison.png&quot;, width = 800, height = 600)
ggplot(eq_24h %&gt;% mutate(Event = fct_inorder(Event)), 
       aes(x = depth, colour = Event, fill = Event)) + 
  geom_density(alpha = 0.3) + 
  facet_zoom(x = depth &lt;= 20 &amp; depth &gt;= 3) +
  theme_solarized() +
  labs(title = &quot;Depths of earthquakes, 24 hours after major quake&quot;,
       caption = &quot;http://david.frigge.nz&quot;)
dev.off()</code></pre>
</div>
<p>Notes on the code:</p>
<ul>
<li>We include blank event types, as these are probably earthquakes. See the <a href="http://info.geonet.org.nz/display/appdata/Catalogue+Output">Geonet docs</a>, and <a href="http://ellisp.github.io/blog/2016/11/19/earthquakes">Peter Ellis’s post</a> for the result of filtering them out.</li>
<li>I’m enjoying using <a href="https://github.com/hadley/purrr">purrr</a> more and more. Creating lists and mapping across them is starting to feel more natural to me.</li>
<li>The events will be ordered alphabetically unless we turn them into a factor (yay for <a href="https://blog.rstudio.org/2016/08/31/forcats-0-1-0/">forcats</a>).</li>
<li><code>facet_zoom</code> is fairly straightforward, which is nice.</li>
</ul>
<h2 id="big-quakes-are-almost-everywhere-or-scatter-plots-on-maps-with-plotly">Big quakes are (almost) everywhere, or, Scatter plots on maps with Plotly</h2>
<p>I’ve “always” known that Wellington was the big risk for quakes, and has had some big ones in the past. And I grew up in Hawkes Bay with the communal memory of the 1931 quake there. But have the big quakes been only in these regions or have they been across the whole country?</p>
<p>I looked at Geonet for all recorded quakes over 7 magnitude; it turns out there have been 30 of them. As you can see below, the quakes span the length of the country, on what looks like a diagonal line, highlighting <a href="https://en.wikipedia.org/wiki/Geology_of_New_Zealand">New Zealand’s position</a> as the meeting place of the Pacific and Australian Plates. Northland looks like the place to be if you’re super scared of earthquakes. Just keep your fingers crossed that <a href="https://en.wikipedia.org/wiki/Auckland_volcanic_field">Auckland’s volcanoes</a> don’t explode!</p>
<p>I’ve plotted the 30 big quakes, coloured by date. For reference, especially for non-kiwis, I’ve also plotted the main towns and cities, scraping this data from Wikipedia.</p>
<div class="layout-chunk" data-layout="l-page">
<div id="htmlwidget-0cdd2f0af692c08e5f71" style="width:624px;height:672px;" class="plotly html-widget"></div>
<script type="application/json" data-for="htmlwidget-0cdd2f0af692c08e5f71">{"x":{"visdat":{"6024468850b2":["function () ","plotlyVisDat"],"602470817212":["function () ","data"]},"cur_data":"602470817212","attrs":{"6024468850b2":{"lat":{},"lon":{},"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"x":{},"y":{},"type":"scatter","mode":"markers","text":{},"size":[10],"marker":{"sizemode":"diameter"},"color":{},"name":"Earthquakes","hoverinfo":"text","inherit":true},"602470817212":{"lat":{},"lon":{},"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"x":{},"y":{},"type":"scatter","mode":"markers","size":[5],"marker":{"sizemode":"diameter"},"color":["black"],"text":{},"hoverinfo":"text","name":"Urban areas","showlegend":true,"inherit":true}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"mapType":"geo","title":"Big quakes (>7M) in New Zealand","geo":{"domain":{"x":[0,1],"y":[0,1]},"scope":"world","showland":true,"resolution":50,"projection":{"type":"conic conformal","rotation":{"lon":172}},"lonaxis":{"range":[156,190]},"lataxis":{"range":[-50,-33]}},"hovermode":"closest","showlegend":true,"legend":{"yanchor":"top","y":0.5}},"source":"A","config":{"modeBarButtonsToAdd":[{"name":"Collaborate","icon":{"width":1000,"ascent":500,"descent":-50,"path":"M487 375c7-10 9-23 5-36l-79-259c-3-12-11-23-22-31-11-8-22-12-35-12l-263 0c-15 0-29 5-43 15-13 10-23 23-28 37-5 13-5 25-1 37 0 0 0 3 1 7 1 5 1 8 1 11 0 2 0 4-1 6 0 3-1 5-1 6 1 2 2 4 3 6 1 2 2 4 4 6 2 3 4 5 5 7 5 7 9 16 13 26 4 10 7 19 9 26 0 2 0 5 0 9-1 4-1 6 0 8 0 2 2 5 4 8 3 3 5 5 5 7 4 6 8 15 12 26 4 11 7 19 7 26 1 1 0 4 0 9-1 4-1 7 0 8 1 2 3 5 6 8 4 4 6 6 6 7 4 5 8 13 13 24 4 11 7 20 7 28 1 1 0 4 0 7-1 3-1 6-1 7 0 2 1 4 3 6 1 1 3 4 5 6 2 3 3 5 5 6 1 2 3 5 4 9 2 3 3 7 5 10 1 3 2 6 4 10 2 4 4 7 6 9 2 3 4 5 7 7 3 2 7 3 11 3 3 0 8 0 13-1l0-1c7 2 12 2 14 2l218 0c14 0 25-5 32-16 8-10 10-23 6-37l-79-259c-7-22-13-37-20-43-7-7-19-10-37-10l-248 0c-5 0-9-2-11-5-2-3-2-7 0-12 4-13 18-20 41-20l264 0c5 0 10 2 16 5 5 3 8 6 10 11l85 282c2 5 2 10 2 17 7-3 13-7 17-13z m-304 0c-1-3-1-5 0-7 1-1 3-2 6-2l174 0c2 0 4 1 7 2 2 2 4 4 5 7l6 18c0 3 0 5-1 7-1 1-3 2-6 2l-173 0c-3 0-5-1-8-2-2-2-4-4-4-7z m-24-73c-1-3-1-5 0-7 2-2 3-2 6-2l174 0c2 0 5 0 7 2 3 2 4 4 5 7l6 18c1 2 0 5-1 6-1 2-3 3-5 3l-174 0c-3 0-5-1-7-3-3-1-4-4-5-6z"},"click":"function(gd) { \n        // is this being viewed in RStudio?\n        if (location.search == '?viewer_pane=1') {\n          alert('To learn about plotly for collaboration, visit:\\n https://cpsievert.github.io/plotly_book/plot-ly-for-collaboration.html');\n        } else {\n          window.open('https://cpsievert.github.io/plotly_book/plot-ly-for-collaboration.html', '_blank');\n        }\n      }"}],"cloud":false},"data":[{"lat":[-42.6925354,-36.97947693,-43.52731,-45.77025,-49.27101,-46.60614,-45.19286,-36.48562,-37.64958,-46.7,-41.76,-37.6,-38.84554,-47.47,-33.7,-45,-40.55,-39.5,-39.3,-41.7,-42.84,-37.5,-40.4,-42.6,-40.2,-40,-41.2,-41.9,-39.6,-45],"lon":[173.0221405,179.5200195,172.16794,166.58707,164.11501,165.31691,166.83005,-178.47597,179.48859,166.03,172.03999,176.48,178.80322,166.12,-179.8,167,176.28999,177.5,177,172.2,171.83,176.5,176.4,172.55,173,176.5,175.2,173.6,176.2,167],"type":"scattergeo","mode":"markers","text":["12:02AM, Monday 14 November 2016<br />7.8 Mw(mB), 15km deep"," 4:37AM, Friday  2 September 2016<br />7.1 M, 22km deep"," 4:35AM, Saturday  4 September 2010<br />7.2 Mw, 11km deep"," 9:22PM, Wednesday 15 July 2009<br />7.8 Mw, 12km deep"," 6:23PM, Sunday 30 September 2007<br />7.3 Mw, 10km deep"," 9:26AM, Tuesday 23 November 2004<br />7 Mw, 12km deep","12:12AM, Friday 22 August 2003<br />7.1 Mw, 24km deep"," 6:51PM, Tuesday 21 August 2001<br />7.1 ML, 33km deep","11:51AM, Monday  6 February 1995<br />7.2 Mw, 12km deep","10:25PM, Friday 12 October 1979<br />7.3 Mw, 12km deep"," 5:24AM, Friday 24 May 1968<br />7.1 Mw, 12km deep"," 1:36PM, Tuesday 29 September 1953<br />7.2 ML, 273km deep"," 8:32AM, Wednesday 26 March 1947<br />7 Mw, 12km deep","10:44AM, Sunday  2 September 1945<br />7.4 Mw, 12km deep"," 2:16AM, Wednesday  7 October 1942<br />7.1 M, 285km deep"," 3:35AM, Saturday 11 February 1939<br />7 M, 25km deep","11:46PM, Monday  5 March 1934<br />7.2 Mw, 12km deep"," 1:27PM, Friday 13 February 1931<br />7.3 Mw, 30km deep","10:47AM, Tuesday  3 February 1931<br />7.4 Mw, 20km deep","10:17AM, Monday 17 June 1929<br />7.3 Mw, 20km deep","10:50PM, Saturday  9 March 1929<br />7 Mw, 12km deep"," 7:44PM, Sunday 22 November 1914<br />7.3 Mw, 300km deep","10:20AM, Tuesday  9 August 1904<br />7 Mw, 16km deep"," 4:15AM, Saturday  1 September 1888<br />7 Mw, 12km deep","12:14AM, Monday 19 October 1868<br />7.2 Mw, 12km deep","12:39AM, Monday 23 February 1863<br />7.5 M, 25km deep"," 9:11PM, Tuesday 23 January 1855<br />8.2 Mw, 33km deep"," 1:49AM, Monday 16 October 1848<br />7.4 Mw, 12km deep"," 5:09PM, Saturday  8 July 1843<br />7.6 Mw, 12km deep","11:39AM, Sunday  1 January 1826<br />7.5 M, 25km deep"],"marker":{"colorbar":{"title":"Year","ticklen":2},"cmin":1826,"cmax":2016,"colorscale":[["0","rgba(68,1,84,1)"],["0.0949561403508764","rgba(72,35,115,1)"],["0.131140350877192","rgba(71,47,123,1)"],["0.178947368421053","rgba(67,61,130,1)"],["0.216666666666666","rgba(63,72,136,1)"],["0.329824561403508","rgba(50,103,142,1)"],["0.423684210526316","rgba(41,125,142,1)"],["0.499342105263158","rgba(37,144,140,1)"],["0.542105263157895","rgba(33,155,138,1)"],["0.551315789473684","rgba(32,157,137,1)"],["0.553947368421053","rgba(31,158,137,1)"],["0.576096491228071","rgba(37,163,134,1)"],["0.602631578947368","rgba(43,168,130,1)"],["0.621710526315789","rgba(46,173,128,1)"],["0.635964912280703","rgba(49,176,126,1)"],["0.678289473684211","rgba(61,185,118,1)"],["0.766666666666666","rgba(105,203,93,1)"],["0.850877192982455","rgba(158,216,63,1)"],["0.913157894736842","rgba(197,224,43,1)"],["0.931140350877192","rgba(209,226,42,1)"],["0.939473684210526","rgba(214,226,41,1)"],["0.956578947368421","rgba(225,228,40,1)"],["0.966228070175439","rgba(231,229,39,1)"],["0.993421052631579","rgba(249,231,37,1)"],["1","rgba(253,231,37,1)"]],"showscale":false,"color":[2016,2016,2010,2009,2007,2004,2003,2001,1995,1979,1968,1953,1947,1945,1942,1939,1934,1931,1931,1929,1929,1914,1904,1888,1868,1863,1855,1848,1843,1826],"size":10,"sizemode":"diameter","line":{"colorbar":{"title":"","ticklen":2},"cmin":1826,"cmax":2016,"colorscale":[["0","rgba(68,1,84,1)"],["0.0949561403508764","rgba(72,35,115,1)"],["0.131140350877192","rgba(71,47,123,1)"],["0.178947368421053","rgba(67,61,130,1)"],["0.216666666666666","rgba(63,72,136,1)"],["0.329824561403508","rgba(50,103,142,1)"],["0.423684210526316","rgba(41,125,142,1)"],["0.499342105263158","rgba(37,144,140,1)"],["0.542105263157895","rgba(33,155,138,1)"],["0.551315789473684","rgba(32,157,137,1)"],["0.553947368421053","rgba(31,158,137,1)"],["0.576096491228071","rgba(37,163,134,1)"],["0.602631578947368","rgba(43,168,130,1)"],["0.621710526315789","rgba(46,173,128,1)"],["0.635964912280703","rgba(49,176,126,1)"],["0.678289473684211","rgba(61,185,118,1)"],["0.766666666666666","rgba(105,203,93,1)"],["0.850877192982455","rgba(158,216,63,1)"],["0.913157894736842","rgba(197,224,43,1)"],["0.931140350877192","rgba(209,226,42,1)"],["0.939473684210526","rgba(214,226,41,1)"],["0.956578947368421","rgba(225,228,40,1)"],["0.966228070175439","rgba(231,229,39,1)"],["0.993421052631579","rgba(249,231,37,1)"],["1","rgba(253,231,37,1)"]],"showscale":false,"color":[2016,2016,2010,2009,2007,2004,2003,2001,1995,1979,1968,1953,1947,1945,1942,1939,1934,1931,1931,1929,1929,1914,1904,1888,1868,1863,1855,1848,1843,1826]}},"name":"Earthquakes","hoverinfo":["text","text","text","text","text","text","text","text","text","text","text","text","text","text","text","text","text","text","text","text","text","text","text","text","text","text","text","text","text","text"],"textfont":{"size":10},"line":{"width":10},"geo":"geo","frame":null},{"lat":[-36.84,-41.29,-43.53,-37.79,-37.68,-39.58,-45.87,-40.36,-41.27,-38.14,-39.07,-35.73,-46.41,-40.84,-39.93,-38.66,-41.51,-37.2,-44.4,-38.69,-40.95,-40.62,-43.91,-37.98,-43.3,-40.22,-45.03,-45.08,-38.23,-43.58,-39.58],"lon":[174.74,174.78,172.62,175.28,176.17,176.85,170.5,175.61,173.28,176.25,174.08,174.32,168.35,175.19,175.05,178.02,173.96,174.9,171.25,176.07,175.66,175.29,171.75,177,172.59,175.57,168.66,170.98,175.87,172.38,174.28],"type":"scattergeo","mode":"markers","marker":{"color":"rgba(0,0,0,1)","size":5,"sizemode":"diameter","line":{"color":"rgba(0,0,0,1)"}},"text":["Auckland Urban Area <br /> Population 1,495,000","Wellington Urban Area <br /> Population 405,000","Christchurch Urban Area <br /> Population 389,700","Hamilton Urban Area <br /> Population 230,000","Tauranga Urban Area <br /> Population 134,400","Napier-Hastings Urban Area <br /> Population 131,000","Dunedin Urban Area <br /> Population 118,500","Palmerston North Urban Area <br /> Population 84,300","Nelson Urban Area <br /> Population 65,700","Rotorua Urban Area <br /> Population 57,800","New Plymouth Urban Area <br /> Population 56,800","Whangarei Urban Area <br /> Population 56,400","Invercargill Urban Area <br /> Population 50,700","Kapiti Urban Area <br /> Population 41,800","Whanganui Urban Area <br /> Population 39,600","Gisborne Urban Area <br /> Population 36,100","Blenheim Urban Area <br /> Population 30,700","Pukekohe Urban Area <br /> Population 29,800","Timaru Urban Area <br /> Population 28,800","Taupo Urban Area <br /> Population 24,100","Masterton Urban Area <br /> Population 21,200","Levin Urban Area <br /> Population 20,600","Ashburton Urban Area <br /> Population 19,850","Whakatane Urban Area <br /> Population 19,600","Rangiora Urban Area <br /> Population 17,350","Feilding Urban Area <br /> Population 16,250","Queenstown Urban Area <br /> Population 14,300","Oamaru Urban Area <br /> Population 13,850","Tokoroa Urban Area <br /> Population 13,700","Rolleston Urban Area <br /> Population 13,100","Hawera Urban Area <br /> Population 11,800"],"hoverinfo":["text","text","text","text","text","text","text","text","text","text","text","text","text","text","text","text","text","text","text","text","text","text","text","text","text","text","text","text","text","text","text"],"name":"Urban areas","showlegend":true,"textfont":{"color":"rgba(0,0,0,1)","size":5},"line":{"color":"rgba(0,0,0,1)","width":5},"geo":"geo","frame":null},{"type":"scattergeo","mode":"markers","opacity":0,"hoverinfo":"none","showlegend":false,"marker":{"colorbar":{"title":"Year","ticklen":2,"len":0.5,"lenmode":"fraction","y":1,"yanchor":"top"},"cmin":1826,"cmax":2016,"colorscale":[["0","rgba(68,1,84,1)"],["0.0949561403508764","rgba(72,35,115,1)"],["0.131140350877192","rgba(71,47,123,1)"],["0.178947368421053","rgba(67,61,130,1)"],["0.216666666666666","rgba(63,72,136,1)"],["0.329824561403508","rgba(50,103,142,1)"],["0.423684210526316","rgba(41,125,142,1)"],["0.499342105263158","rgba(37,144,140,1)"],["0.542105263157895","rgba(33,155,138,1)"],["0.551315789473684","rgba(32,157,137,1)"],["0.553947368421053","rgba(31,158,137,1)"],["0.576096491228071","rgba(37,163,134,1)"],["0.602631578947368","rgba(43,168,130,1)"],["0.621710526315789","rgba(46,173,128,1)"],["0.635964912280703","rgba(49,176,126,1)"],["0.678289473684211","rgba(61,185,118,1)"],["0.766666666666666","rgba(105,203,93,1)"],["0.850877192982455","rgba(158,216,63,1)"],["0.913157894736842","rgba(197,224,43,1)"],["0.931140350877192","rgba(209,226,42,1)"],["0.939473684210526","rgba(214,226,41,1)"],["0.956578947368421","rgba(225,228,40,1)"],["0.966228070175439","rgba(231,229,39,1)"],["0.993421052631579","rgba(249,231,37,1)"],["1","rgba(253,231,37,1)"]],"showscale":true,"color":[1826,2016],"line":{"color":"rgba(44,160,44,1)"}},"lat":[-179.8,179.5200195],"lon":[-49.27101,-33.7],"geo":"geo","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.2,"selected":{"opacity":1},"debounce":0},"base_url":"https://plot.ly"},"evals":["config.modeBarButtonsToAdd.0.click"],"jsHooks":[]}</script>
</div>
<h3 id="code-listing-1">Code listing</h3>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
library(readr)
library(dplyr)
library(plotly)
library(lubridate)
big_eq &lt;- 
  read_csv(&quot;data/big_nz_quakes.csv&quot;) %&gt;% 
  # read_csv(&quot;http://quakesearch.geonet.org.nz/csv?bbox=162.99316,-49.66763,182.37305,-32.91649&amp;minmag=7&amp;startdate=1800-01-01T0:00:00&amp;enddate=2016-12-31T23:00:00&quot;) %&gt;% 
  mutate(origintime = with_tz(origintime, &quot;Pacific/Auckland&quot;),
         magnitude = round(magnitude, 1),
         depth = round(depth, 0),
         Year = year(origintime))

nzua &lt;- read_tsv(&quot;data/nz_urban_areas.tsv&quot;, skip = 1, col_types = &quot;icccnn&quot;)

plot_geo(big_eq, 
         lat = ~latitude, lon = ~longitude) %&gt;% 
  add_markers(text = ~paste0(format(origintime, &quot;%l:%M%p, %A %e %B %Y&quot;), &quot;&lt;br /&gt;&quot;,
                             magnitude, &quot; &quot;, magnitudetype, &quot;, &quot;, depth, &quot;km deep&quot;),
              size = I(10),
              marker = list(sizemode = &#39;diameter&#39;),
              color = ~Year,
              name = &quot;Earthquakes&quot;,
              hoverinfo = &quot;text&quot;) %&gt;% 
  add_markers(data = nzua %&gt;% rename(latitude = Latitude, longitude = Longitude),
              size = I(5),
              marker = list(sizemode = &#39;diameter&#39;),
              color = I(&quot;black&quot;),
              text = ~paste0(Name, &quot; Urban Area &lt;br /&gt; Population &quot;, Population),
              hoverinfo = &quot;text&quot;,
              name = &quot;Urban areas&quot;,
              showlegend = T) %&gt;%
  layout(title = &quot;Big quakes (&gt;7M) in New Zealand&quot;,
         geo = list(scope = &quot;world&quot;,
                    showland = TRUE,
                    resolution = 50,
                    projection = list(
                      type = &quot;conic conformal&quot;,
                      rotation = list(lon = 172)
                    ),
                    lonaxis = list(range = c(156,190)),
                    lataxis = list(range = c(-50,-33))))</code></pre>
</div>
<p>Notes on the code:</p>
<ul>
<li><a href="https://github.com/hadley/lubridate">Lubridate</a> is great for processing dates; <code>with_tz</code> allows easy conversion from UTC. I had thought that <code>stamp</code> might allow me easy display formatting, but I couldn’t get it to work sensibly so reverted to <code>format</code>.</li>
<li>I considered sizing the points based on magnitude, but it didn’t work when I added the second trace. I figured it didn’t add a lot to the “story” so didn’t bother pursuing it.</li>
<li><del>Frustratingly, I didn’t figure out how to make the map bigger. Both the knitr <code>fig.height</code> option, and the height option in Plotly’s <code>layout</code> function made the figure area bigger, but not the box with the map in.</del> <strong>Nov 2018:</strong> This seems to work better now, but I’m not sure whether it’s changes in Plotly, or due to the switch to Radix for publishing.</li>
<li><strong>Nov 2018:</strong> In recompiling this code, the markers (nearly) all disappeared. I had set the sizing to diameter, as per <a href="https://github.com/ropensci/plotly/issues/1133">issue 1133</a>.</li>
</ul>
<p>On the whole, I’m not entirely happy with this. If I’d had more time I’m sure I would have thought more about the design, and hopefully solved all of the technical issues I ran in to. It was interesting to try out Plotly’s mapping capabilities, but next time I think I’ll reach for <a href="https://rstudio.github.io/leaflet/">leaflet</a> first.</p>
<!--radix_placeholder_article_footer-->
<!--/radix_placeholder_article_footer-->
</div>

<div class="d-appendix">
</div>


<!--radix_placeholder_site_after_body-->
<!--/radix_placeholder_site_after_body-->
<!--radix_placeholder_appendices-->
<div class="appendix-bottom">
  <h3 id="updates-and-corrections">Corrections</h3>
  <p>If you see mistakes or want to suggest changes, please <a href="https://github.com/dakvid/dakvid.github.io/issues/new">create an issue</a> on the source repository.</p>
  <h3 id="reuse">Reuse</h3>
  <p>Text and figures are licensed under Creative Commons Attribution <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>. Source code is available at <a href="https://github.com/dakvid/dakvid.github.io">https://github.com/dakvid/dakvid.github.io</a>, unless otherwise noted. The figures that have been reused from other sources don't fall under this license and can be recognized by a note in their caption: "Figure from ...".</p>
</div>
<!--/radix_placeholder_appendices-->
<!--radix_placeholder_navigation_after_body-->
<!--/radix_placeholder_navigation_after_body-->

</body>

</html>
